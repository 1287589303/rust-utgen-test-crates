n must be in the range 0x800 to 0xFFFF, and scratch must be a mutable Vec<u8> with at least 4 bytes reserved.
