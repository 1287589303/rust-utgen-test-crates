self.states.len() should be less than the maximum value of StateID, and self.free should contain at least one state to pop.
