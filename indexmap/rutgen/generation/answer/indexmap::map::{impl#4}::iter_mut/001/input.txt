Capacity must be greater than or equal to 0, state must be non-empty for valid iteration, check both when the map has items and when it is empty.
